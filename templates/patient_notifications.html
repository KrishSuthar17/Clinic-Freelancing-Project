{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto mt-10 bg-white p-6 rounded-xl shadow">


    <h2 class="text-xl font-bold text-center mb-4">
        ðŸ“¢ Appointment Notifications
    </h2>
    <br>
    <form method="post" class="space-y-4 mt-6">
        {% csrf_token %}
        <input type="text" maxlength="10" name="phone" placeholder="Enter your phone number" value="{{ phone|default:'' }}"
            class="w-full border rounded px-4 py-2" required>

        <p class=" text-red-600 mt-2">Please Enable Notifications for confirmation and cancellation your appointments.</p>
        <button
        type="button"
        id="enablePatientNotifications"
        class="w-full mt-4 bg-green-600 text-white py-2 rounded font-semibold"
        >
        ðŸ”” Enable Appointment Notifications
    </button>
        <button type="submit" class="w-full bg-blue-600 text-black py-2 rounded font-semibold">
            View Notifications
        </button>
        

    </form>

    {% if error %}
    <p class="mt-4 text-red-600 text-sm text-center">
        {{ error }}
    </p>
    {% endif %}

    {% if notifications %}
    <ul class="mt-6 space-y-3">
        {% for n in notifications %}
        <li class="border rounded p-3 bg-gray-50">
            <p class="font-semibold">{{ n.title }}</p>
            <p class="text-sm text-gray-600">{{ n.message }}</p>
            <p class="text-xs text-gray-400 mt-1">
                {{ n.created_at|date:"d M Y, H:i" }}
            </p>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<script>

  // 1ï¸âƒ£ Init Firebase FIRST
  firebase.initializeApp({
    apiKey: "AIzaSyCEHTsXR53kbgYEQ2TrlhqMN_2F0Gzs4TM",
    authDomain: "clinic-notifications.firebaseapp.com",
    projectId: "clinic-notifications",
    messagingSenderId: "966949240460",
    appId: "1:966949240460:web:892b509260d0d660fc05a9",
  });

   const messaging = firebase.messaging();

  const btn = document.getElementById("enablePatientNotifications");

  if (!btn) {
    console.error("âŒ Enable button not found");
  } else {
    btn.addEventListener("click", async () => {
      console.log("ðŸŸ¢ Button clicked");

      // 1ï¸âƒ£ Ask permission FIRST
      const permission = await Notification.requestPermission();
      console.log("Permission:", permission);

      if (permission !== "granted") {
        alert("Notification permission denied");
        return; // âœ… LEGAL (inside function)
      }

      // 2ï¸âƒ£ Get phone AFTER permission
      const phoneInput = document.querySelector("input[name='phone']");
      const phone = phoneInput ? phoneInput.value.trim() : "";
      console.log("PHONE VALUE =", phone);

      if (!/^[6-9]\d{9}$/.test(phone)) {
        alert("Enter valid 10-digit phone number");
        return; // âœ… LEGAL
      }

      // 3ï¸âƒ£ Get token
      const token = await messaging.getToken({
        vapidKey: "BJSaZGxtvJCDGFyGvqbZDoTCujGjOOqOYG7Pdjhu1svf_AWwk1642KGfOXq83zTr9i-wg7tTsx-3TxrSIfdGe_4"
      });
      if (!token) {
        alert("Failed to get notification token");
        return;
      }


      console.log("âœ… PATIENT TOKEN:", token);

      // 4ï¸âƒ£ Send to backend
      const res = await fetch("/register-device/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCSRFToken(),
        },
        body: new URLSearchParams({
          user_type: "patient",
          phone: phone,
          token: token,
        }),
      });


      console.log("REGISTER RESPONSE:", res.status);

      if (res.ok) {
        alert("âœ… Notifications enabled");
      } else {
        alert("âŒ Failed to register device");
      }
    });
  }

  // 3ï¸âƒ£ Foreground notification listener
  messaging.onMessage((payload) => {
    console.log("ðŸ“© PATIENT MESSAGE:", payload);

    new Notification(payload.notification.title, {
      body: payload.notification.body,
    });
  });
</script>


{% endblock %}