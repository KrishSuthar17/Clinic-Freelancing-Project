{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto mt-10 bg-white p-6 rounded-xl shadow">

    <h2 class="text-xl font-bold text-center mb-4">
        ðŸ“¢ Appointment Notifications
    </h2>

    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="text" name="phone" placeholder="Enter your phone number" value="{{ phone|default:'' }}"
            class="w-full border rounded px-4 py-2" required>

        <button type="submit" class="w-full bg-blue-600 text-black py-2 rounded font-semibold">
            View Notifications
        </button>
        <br>
        <button id="enablePatientNotifications">Enable</button>
    </form>

    {% if error %}
    <p class="mt-4 text-red-600 text-sm text-center">
        {{ error }}
    </p>
    {% endif %}

    {% if notifications %}
    <ul class="mt-6 space-y-3">
        {% for n in notifications %}
        <li class="border rounded p-3 bg-gray-50">
            <p class="font-semibold">{{ n.title }}</p>
            <p class="text-sm text-gray-600">{{ n.message }}</p>
            <p class="text-xs text-gray-400 mt-1">
                {{ n.created_at|date:"d M Y, H:i" }}
            </p>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

</div>

<script>
    messaging.onMessage(function (payload) {
        console.log("ðŸ“© patient payload:", payload);

        new Notification(
            payload.notification.title,
            { body: payload.notification.body }
        );
    });

    firebase.initializeApp({ ...});

    const messaging = firebase.messaging();

    const token = await messaging.getToken({ vapidKey: '...' });

    fetch('/register-device/', {
        body: { phone: 'YOUR_REAL_PHONE', user_type: 'patient', fcm_token: token }
    });

</script>

{% endblock %}