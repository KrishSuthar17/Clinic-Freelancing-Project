{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto mt-10 bg-white p-6 rounded-xl shadow">


  <h2 class="text-xl font-bold text-center mb-4">
    üì¢ Appointment Notifications
  </h2>
  <br>
  <form method="post" class="space-y-4 mt-6">
    {% csrf_token %}
    <input type="text" maxlength="10" name="phone" placeholder="Enter your phone number" value="{{ phone|default:'' }}"
      class="w-full border rounded px-4 py-2" required>

    <p class=" text-red-600 mt-2">Please Enable Notifications for confirmation and cancellation your appointments.</p>
    <button type="button" id="enablePatientNotifications"
      class="w-full mt-4 bg-green-600 text-white py-2 rounded font-semibold">
      üîî Enable Appointment Notifications
    </button>
    <button type="submit" class="w-full bg-blue-600 text-black py-2 rounded font-semibold">
      View Notifications
    </button>


  </form>

  {% if error %}
  <p class="mt-4 text-red-600 text-sm text-center">
    {{ error }}
  </p>
  {% endif %}

  {% if notifications %}
  <ul class="mt-6 space-y-3">
    {% for n in notifications %}
    <li class="border rounded p-3 bg-gray-50">
      <p class="font-semibold">{{ n.title }}</p>
      <p class="text-sm text-gray-600">{{ n.message }}</p>
      <p class="text-xs text-gray-400 mt-1">
        {{ n.created_at|date:"d M Y, H:i" }}
      </p>
    </li>
    {% endfor %}
  </ul>
  {% endif %}



</div>

<script>
  const btn = document.getElementById("enablePatientNotifications");

  btn.addEventListener("click", async () => {
    try {
      console.log("üü¢ Button clicked");

      // 1Ô∏è‚É£ Permission
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        alert("Permission denied");
        return;
      }

      // 2Ô∏è‚É£ Phone
      const phone = document.querySelector("input[name='phone']").value.trim();
      if (!/^[6-9]\d{9}$/.test(phone)) {
        alert("Enter valid phone number");
        return;
      }

      // 3Ô∏è‚É£ ENSURE SERVICE WORKER
      const swReg = await ensureServiceWorker();

      // await resetPushSubscription();
      let token = localStorage.getItem("patient_fcm_token");


      // 4Ô∏è‚É£ GET TOKEN (THIS WAS FAILING BEFORE)
      if (!token) {
        token = await window.messaging.getToken({
          vapidKey: "BJSaZGxtvJCDGFyGvqbZDoTCujGjOOqOYG7Pdjhu1svf_AWwk1642KGfOXq83zTr9i-wg7tTsx-3TxrSIfdGe_4",
          serviceWorkerRegistration: swReg,
        });

        if (!token) {
          alert("Failed to get token");
          return;
        }
        localStorage.setItem("patient_fcm_token", token);
      }

      console.log("‚úÖ PATIENT TOKEN:", token);

      // 5Ô∏è‚É£ Send to backend
      const res = await fetch("/register-device/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCSRFToken(),
        },
        body: new URLSearchParams({
          user_type: "patient",
          phone: phone,
          token: token,
        }),
      });

      if (res.ok) {
        alert("‚úÖ Notifications enabled");
      } else {
        alert("‚ùå Registration failed");
      }

    } catch (err) {
      console.error("‚ùå Patient notification error:", err);
      alert("Notification setup failed");
    }
  });
</script>



{% endblock %}