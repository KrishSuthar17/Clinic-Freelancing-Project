{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    {% block title %}
    Dr.Ketul Soni Homeopathic Clinic
    {% endblock %}
  </title>

  {% tailwind_css %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    /* Disabled dates â€“ clearly grey */
    .flatpickr-day.disabled,
    .flatpickr-day.disabled:hover {
      background-color: #f3f4f6 !important;
      /* light gray */
      color: #9ca3af !important;
      /* gray text */
      cursor: not-allowed !important;
      text-decoration: line-through;
    }

    /* Today highlight */
    .flatpickr-day.today {
      border-color: #2563eb !important;
    }
  </style>
</head>

<body class="bg-background text-foreground">
  {% include 'components/navbar.html' %}

  {% block content %}
  <link rel="manifest" href="{% static 'manifest.json' %}" />
  <meta name="theme-color" content="#2563eb" />
  {% endblock %}
  <input type="hidden" id="csrf-token" value="{{ csrf_token }}" />

  {% include 'components/footer.html' %}

  <!-- <script src="{% static 'js/ui.js' %}"></script> -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


  <script>
    /* =========================
      CSRF HELPER (UNCHANGED)
   ========================= */
    function getCSRFToken() {
      const name = "csrftoken";
      const cookies = document.cookie.split(";");

      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          return cookie.substring(name.length + 1);
        }
      }
      return null;
    }

    /* =========================
   FIREBASE INIT (SAFE â€“ ONCE)
========================= */
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyCEHTsXR53kbgYEQ2TrlhqMN_2F0Gzs4TM",
        authDomain: "clinic-notifications.firebaseapp.com",
        projectId: "clinic-notifications",
        messagingSenderId: "966949240460",
        appId: "1:966949240460:web:892b509260d0d660fc05a9",
      });
    }

    // ðŸ”¥ GLOBAL messaging instance (ONLY ONCE)
    window.messaging = firebase.messaging();

    /* =========================
      SERVICE WORKER (FIXED)
      âœ… single registration
      âœ… waits until active
   ========================= */
    // ðŸ” Ensure SW is registered & ready
    async function ensureServiceWorker() {
      if (!("serviceWorker" in navigator)) {
        throw new Error("Service Worker not supported");
      }

      const reg = await navigator.serviceWorker.register(
        "/firebase-messaging-sw.js"
      );

      await navigator.serviceWorker.ready;
      return reg;
    }

    async function resetPushSubscription() {
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.getSubscription();

      if (sub) {
        console.log("ðŸ§¹ Removing old push subscription");
        await sub.unsubscribe();
      }
    }
    /* =========================
       OPTIONAL: BASIC PERMISSION
    ========================= */
    async function requestNotificationPermission() {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        console.log("Notification permission granted");
      } else {
        console.log("Notification permission denied");
      }
    }

    /* =========================
       DEV TOOL (UNCHANGED)
    ========================= */
    async function registerFakeDevice() {
      const fakeToken = crypto.randomUUID();

      try {
        const res = await fetch("/register-device/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCSRFToken(),
          },
          body: new URLSearchParams({
            token: fakeToken,
            user_type: "doctor",
          }),
        });

        if (res.ok) {
          console.log("âœ… Device registered:", fakeToken);
          alert("Device registered for notifications");
        } else {
          console.error("âŒ Device registration failed");
        }
      } catch (err) {
        console.error("âŒ Error registering device", err);
      }
    }

    /* =========================
        NAVBAR (UNCHANGED)
    ========================= */

    const hamburger = document.getElementById("hamburger");
    const navLinks = document.getElementById("navLinks");

    if (hamburger && navLinks) {
      hamburger.addEventListener("click", () => {
        navLinks.classList.toggle("show");
      });
    }
  </script>
</body>

</html>