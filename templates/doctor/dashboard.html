{% extends "base.html" %}

{% block content %}

<h1>Doctor Dashboard</h1>

<button id="enableNotificationsBtn" style="padding:10px;background:#16a34a;color:white;border-radius:6px;">
  üîî Enable Real Notifications
</button>



<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/firebase-messaging-sw.js")
      .then(() => console.log("‚úÖ Doctor SW registered"))
      .catch(err => console.error("‚ùå Doctor SW failed", err));
  }
</script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<script>
  console.log("üî• Dashboard script loaded");

  firebase.initializeApp({
    apiKey: "{{GOOGLE_MAPS_API_KEY}}",
    authDomain: "{{authDomain}}",
    projectId: "{{projectId}}",
    messagingSenderId: "{{messagingSenderId}}",
    appId: "{{appId}}",
  });

  const messaging = firebase.messaging();

  messaging.onMessage(function (payload) {
    console.log("üì© DOCTOR RECEIVE:", payload);
  });


  document
    .getElementById("enableNotificationsBtn")
    .addEventListener("click", async () => {

      try {

        const swReg = await ensureServiceWorker();

        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          alert("Permission denied");
          return;
        }

        const token = await messaging.getToken({
          vapidKey: "BJSaZGxtvJCDGFyGvqbZDoTCujGjOOqOYG7Pdjhu1svf_AWwk1642KGfOXq83zTr9i-wg7tTsx-3TxrSIfdGe_4",
          serviceWorkerRegistration: swReg,
        });

        if (!token) {
          alert("Token error");
          return;
        }
        console.log("FCM token:", token);


        // 4Ô∏è‚É£ Register device
        const res = await fetch("/register-device/", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": getCSRFToken(),
          },
          body: new URLSearchParams({
            user_type: "doctor",
            token: token,
          }),
        });

        if (res.ok) {
          alert("‚úÖ Doctor notifications enabled");
        } else {
          alert("‚ùå Registration failed");
        }

      } catch (err) {
        console.error("‚ùå Doctor notification error:", err);
      }
    });
</script>


{% endblock %}